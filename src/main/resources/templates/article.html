<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/main.html">
<div layout:fragment="content">
    <input type="hidden" id="articleId" th:value="${articleId}">
    <div id="article"></div>
    <script type="text/javascript">
        let articleId = document.getElementById("articleId").value
        loadArticle(articleId)

        function loadArticle(articleId) {
            let req = new XMLHttpRequest()
            req.open("GET", "http://localhost:8080/api/article/" + articleId)
            req.onload = function () {
                let article = JSON.parse(req.responseText)
                let authorReq = new XMLHttpRequest()
                authorReq.open("GET", "http://localhost:8080/api/user/" + article.authorId);
                authorReq.onload = function () {
                    let authorFullName = authorReq.responseText
                    let categoriesReq = new XMLHttpRequest();
                    categoriesReq.open("GET", "http://localhost:8080/api/article/" + articleId + "/categories");
                    categoriesReq.onload = function () {
                        let categories = JSON.parse(categoriesReq.responseText);

                        let commentsReq = new XMLHttpRequest();
                        commentsReq.open("GET", "http://localhost:8080/api/article/" + articleId + "/comments");
                        commentsReq.onload = function () {
                            let comments = JSON.parse(commentsReq.responseText);
                            let html = ""
                            html += "<div class='row g-5'>"
                            html += "<div class='col-md-8'>"
                            html += "<article class='blog-post'>"
                            html += "<h2 class='display-5 link-body-emphasis mb-1'>" + article.title + "</h2>"
                            html += "<p class='blog-post-meta'>" + article.postTime + " by <a href=\"#\">" + authorFullName + "</a></p>"
                            html += "<p>" + article.text + "</p>"
                            html += "<p>" + comments.commentText + "</p>"
                            html += "<button type='button' class='btn btn-link'>" + categories.name + "</button>"
                            html += "</div>"
                            html += "</div>"
                            document.getElementById("article").innerHTML = html
                        }
                        commentsReq.send()
                    }
                    categoriesReq.send()
                }
                authorReq.send();
            }
            req.send()
        }
    </script>
</div>
</html>
